import pandas as pd
import json
import openpyxl
import numpy as np

#creat the json file with default values
def create_json(data,tag,DSType):
#Loop Dictionary
    list1 = []
    Js_dictData = pd.DataFrame(data)
    sectionkey = (Js_dictData.loc[Js_dictData['Key'] == tag])

    loop = Js_dictData.loc[Js_dictData['Key'] == tag]
    lp = (loop['Loop'].max())
    uniquelp = (loop['Loop'].unique())

    for l in uniquelp:
        dict1={}
        for key,value in zip(sectionkey[sectionkey['Loop']==l]['InputFile'],sectionkey[sectionkey['Loop']==l]['FixedValue'].fillna("")):
            
            dict1[key] = value
        list1.append(dict1)
    
    if DSType == 'Dict':
        return dict1
    else:
        return list1

def get_value_from_nested_structure(data, key_path):
    current_value = data
    for key in key_path:
        if isinstance(current_value, dict) and key in current_value:
            current_value = current_value[key]
        elif isinstance(current_value, list) and isinstance(key, int) and 0 <= key < len(current_value):
            current_value = current_value[key]
        else:
            return None  # or raise an exception if the key path is invalid
    return current_value

def set_nested_value(d, keys, value):
    current_dict = d
    for key in keys[:-1]:
        if isinstance(key,int):
            current_dict = current_dict[key]
        else:
            current_dict = current_dict.setdefault(key, {})
    lastkey = keys[-1]
    if isinstance(lastkey,int):
        current_dict[lastkey] = value
    else:
        current_dict[lastkey] = value

def count_items(data,key):
    keylist = []
    InputJsonKey = key.split(',')
    for k in InputJsonKey:
                if k.isnumeric() == True:
                    keylist.append(int(k))
                else:
                    keylist.append(k) 
    for key in keylist:
        if isinstance(data[key],dict):
            data = data[key]
        elif isinstance(data[key],list):
            data= data[key]
        
    return len(data)

def get_keylist(Keys):
    InputJsonKey = Keys.split(',') 
    keylist = []
    for k in InputJsonKey:
        if k.isnumeric() == True:
            keylist.append(int(k))
        else:
            keylist.append(k)
    return keylist

def update_json(HxData,InputJson,Refdata,key,Loop,BusinessSegment,l1=0,l2=0,l3=0,l4=0,l5=0,l6=0,l7=0,l8=0,l9=0):

    JsData = InputJson
    HxInputData = HxData
    dsExtract = Refdata
    
    dataset = data.loc[data['Key'] == key].fillna("")
    InputJsondata = dataset[dataset['InputJsonValue']!= ""]
    filterdata = InputJsondata[InputJsondata['Flag']== Loop]
    for row in filterdata.itertuples():
        
        KeyValue = row.InputJsonValue.replace('$',str(l1)).replace('#',str(l2)).replace('@',str(l3)).replace('α',str(l4)).replace('β',str(l5)).replace('γ',BusinessSegment)
        keylist = []
        keylist = get_keylist(KeyValue)
        InputJsonVal = get_value_from_nested_structure(JsData,keylist)
        SetVal = row.HxSetValue.replace('$',str(l1)).replace('#',str(l2)).replace('@',str(l3)).replace('α',str(l4)).replace('β',str(l6))
        Hxkeylist = []
        Hxkeylist = get_keylist(SetVal)
        if InputJsonVal is None:
            InputJsonVal = ""
        #print(row.Key,'-',row.InputFile,'-',row.InputJsonValue,'-',keylist,'-',row.Hierarchy,'-',Hxkeylist,'-',InputJsonVal)
        set_nested_value(HxInputData,Hxkeylist,InputJsonVal)
        
    DataExtractJson = dataset[dataset['DataExtractionValue']!= ""]
    filterExtractdata = DataExtractJson[DataExtractJson['Flag']== Loop]

    for row in filterExtractdata.itertuples():
        keyval = row.DataExtractionValue.split('|')
        keylist = ''
        if len(keyval) > 1:
            for k in keyval:
                JsonKey = get_keylist(k.replace('$',str(l1)).replace('#',str(l2)).replace('@',str(l3)).replace('α',str(l4)).replace('β',str(l4)).replace('γ',BusinessSegment))
                val = get_value_from_nested_structure(JsData,JsonKey)
                if val is None:
                    keylist = keylist + str(k) + ','
                else:
                    keylist = keylist + str(val) + ','

            datakeylist = []
            datakeylist = get_keylist(keylist.rstrip(','))
            DataExtractJsonVal = get_value_from_nested_structure(dsExtract,datakeylist)
        else :
            DataExtractionValue = row.DataExtractionValue
            datakeylist = get_keylist(DataExtractionValue)
            DataExtractJsonVal = get_value_from_nested_structure(dsExtract,datakeylist)

        Hxkeylist = get_keylist(row.HxSetValue)
        SetVal = row.HxSetValue.replace('$',str(l1)).replace('#',str(l2)).replace('@',str(l3)).replace('α',str(l4)).replace('β',str(l4))
        SetExKey = []
        SetExKey = get_keylist(SetVal)
        if DataExtractJsonVal is None:
            DataExtractJsonVal = ""
        #print(row.Key,'-',row.InputFile,'-',row.DataExtractionValue,'-',DataExtractJsonVal,'-',row.Hierarchy,'-',SetExKey)
        set_nested_value(HxInputData,SetExKey,DataExtractJsonVal)

def rename_keys(data,KeyPath,OldKey,NewKey):
    current_dict = data
    temp_dict = data
    for key in KeyPath:
        if isinstance(key,int):
            current_dict = current_dict[key]
        elif key in current_dict:
            current_dict = current_dict[key]
    current_dict[NewKey] = current_dict.pop(OldKey)

df = pd.read_excel(r"C:\Python Workspace\NewImplementation\MappingSheet.xlsx")

loopdf = pd.read_excel(r"C:\Python Workspace\NewImplementation\MappingSheet.xlsx",sheet_name="Loops")

dfCreatJson = pd.read_excel(r"C:\Python Workspace\NewImplementation\MappingSheet.xlsx",sheet_name="Creation")

dfRenameKeys = pd.read_excel(r"C:\Python Workspace\NewImplementation\MappingSheet.xlsx",sheet_name="RenameKeys")

segment = pd.read_excel(r"C:\Python Workspace\NewImplementation\MappingSheet.xlsx",sheet_name="BusinessSegment")

with open(r"C:\Python Workspace\NewImplementation\PriSync InputJSON.json") as jsread:
    JsData = json.load(jsread)

with open(r"C:\Python Workspace\PV\DataExtractionJSON.json") as dsread:
    dsExtract = json.load(dsread)

data = pd.DataFrame(df)

data = data.astype({'Loop' : int})

distinctkeys = data['Key'].unique()

Hierarchy = data['Hierarchy'].fillna(" ").unique()

distinctHierarchy = []

for k in Hierarchy:
    if k !=" " and k!="NaN":
        distinctHierarchy.append(k)

list1 = []
finaldict = {}
dict3={}

#create key-value pair from mapping sheet

for key in distinctkeys:
    Datakey = data[data['Key']==key]
    DsType = Datakey['DSType'].unique()
    list1.append(create_json(data,key,DsType))
    finaldict[key] = create_json(data,key,DsType)


#Create Empty Json Files

if distinctkeys[0] == 'Root':
    dict3 = finaldict['Root']

# print(dict3)

for key in distinctHierarchy:
    keylist = []
    keylist = get_keylist(key)
    set_nested_value(dict3,keylist,finaldict[keylist[-1]])

Renamekeys = pd.DataFrame(dfRenameKeys)
for row in Renamekeys.itertuples():
    KeyPath = get_keylist(row.KeyPath)
    rename_keys(dict3,KeyPath,row.OldKey,row.NewKey)



# print(finaldict['Sections'])
jsonstructure = pd.DataFrame(dfCreatJson)

for key in distinctkeys:
    Jsonstruct = jsonstructure.loc[jsonstructure['Keys'] == key]
    for row in Jsonstruct.itertuples():
        keys = row.Keys
        Loop = count_items(JsData,row.Loop)
        keylist = []
        keylist = get_keylist(row.PlacementKeys)
        tempdict = {}
        tempdict = finaldict[key]
        if isinstance(tempdict,list):
            set_nested_value(dict3,keylist,tempdict*Loop)
        else:
            set_nested_value(dict3,keylist,tempdict)
    



out_file = open(r"C:\Python Workspace\NewImplementation\HxInputTemplate.json","w")

json.dump(dict3,out_file,indent=6)

out_file.close()

#BusinessSegemtn for Additional CENDMob_Additional

BSKey = segment['SegmentKey'].unique()

BSegment = get_value_from_nested_structure(JsData,BSKey)

SegmentKey = pd.DataFrame(segment)

dictBS = {}
BusinessSegment = ''
for row in SegmentKey.itertuples():
    dictBS.setdefault(row.Segment,row.Key)

BusinessSegment = dictBS[BSegment]

#Updating the JsonFile

with open(r"C:\Python Workspace\NewImplementation\HxInputTemplate.json") as HxInput:
    HxInputData = json.load(HxInput)

LoopValues = pd.DataFrame(loopdf)

for key in distinctkeys:
    update_json(HxInputData,JsData,dsExtract,key,'NotInLoop',BusinessSegment)

Levels = {}

for row in LoopValues.itertuples():
    #print(row.Key,count_items(JsData,row.InputKey))
    Levels[row.Key] = count_items(JsData,row.InputKey)

Levellist = []
Valuelist = []

for key,value in Levels.items():
    Levellist.append(key)
    Valuelist.append(value)

#We need to update the below part of the code to have the nested loop structure
#for differeent models.
#The level of nesting will be coming from the mapping sheet


InputModel = 'WA'
match InputModel:
    case 'WA':
        for l1 in range(Valuelist[0]): #Sections
            update_json(HxInputData,JsData,dsExtract,Levellist[0],'InLoop',BusinessSegment,l1)
            for l2 in range(Valuelist[1]):   #SectionParties
                update_json(HxInputData,JsData,dsExtract,Levellist[1],'InLoop',BusinessSegment,l1,l2)
                for l3 in range(Valuelist[2]): #SectionPartyFinancialTypes
                    update_json(HxInputData,JsData,dsExtract,Levellist[2],'InLoop',BusinessSegment,l1,l2,l3)
            for l4 in range(Valuelist[3]):   #Coverages
                update_json(HxInputData,JsData,dsExtract,Levellist[3],'InLoop',BusinessSegment,l1,l4)
                for l5 in range(Valuelist[4]):   #CoverageExposures
                    update_json(HxInputData,JsData,dsExtract,Levellist[4],'InLoop',BusinessSegment,l1,l4,l5)
                    for l6 in range(Valuelist[5]):   #Location
                        update_json(HxInputData,JsData,dsExtract,Levellist[5],'InLoop',BusinessSegment,l1,l4,l5,l6)
                    for l7 in range(Valuelist[6]):   #CoverageExposureFinancialTypes
                        update_json(HxInputData,JsData,dsExtract,Levellist[6],'InLoop',BusinessSegment,l1,l4,l5,l7)
                for l8 in range(Valuelist[7]):   #CoverageLimitExcessDeductibles
                    update_json(HxInputData,JsData,dsExtract,Levellist[7],'InLoop',BusinessSegment,l1,l4,l8)
                for l9 in range(Valuelist[8]):   #CoverageRatingFactorTypes
                    update_json(HxInputData,JsData,dsExtract,Levellist[8],'InLoop',BusinessSegment,l1,l4,l9)
            for l10 in range(Valuelist[9]):   #SectionRatingFactorTypes
                update_json(HxInputData,JsData,dsExtract,Levellist[9],'InLoop',BusinessSegment,l1,l10)
            for l11 in range(Valuelist[10]):   #SectionFinancials
                update_json(HxInputData,JsData,dsExtract,Levellist[10],'InLoop',BusinessSegment,l1,l11)

    case 'CM':
        for l1 in range(Valuelist[0]): #Contracts
            update_json(Levellist[0],'InLoop',BusinessSegment,l1)
            for l2 in range(Valuelist[1]):   #ContractParties
                update_json(Levellist[1],'InLoop',BusinessSegment,l1,l2)
                for l3 in range(Valuelist[2]): #PartyFinancialTypes
                    update_json(Levellist[2],'InLoop',BusinessSegment,l1,l2,l3)
            for l4 in range(Valuelist[3]):   #ContractRatingFactorTypes
                update_json(Levellist[3],'InLoop',BusinessSegment,l1,l4)
            for l5 in range(Valuelist[4]):   #Sections
                update_json(Levellist[4],'InLoop',BusinessSegment,l1,l5)
                for l6 in range(Valuelist[5]):   #SectionLimitExcessDeductibles
                    update_json(Levellist[5],'InLoop',BusinessSegment,l1,l5,l6)
                for l7 in range(Valuelist[6]):   #SectionParties
                    update_json(Levellist[6],'InLoop',BusinessSegment,l1,l5,l7)
                    for l8 in range(Valuelist[7]):   #PartyFinancialTypes
                        update_json(Levellist[7],'InLoop',BusinessSegment,l1,l5,l7,l8)
                for l9 in range(Valuelist[8]):   #Coverages
                    update_json(Levellist[8],'InLoop',BusinessSegment,l1,l5,l9)
                    for l10 in range(Valuelist[9]):   #CoverageLimitExcessDeductibles
                        update_json(Levellist[9],'InLoop',BusinessSegment,l1,l5,l9,l10)
                    for l11 in range(Valuelist[10]):   #CoverageRatingFactorTypes
                        update_json(Levellist[10],'InLoop',BusinessSegment,l1,l5,l9,l11)
                for l12 in range(Valuelist[11]):   #SectionFinancialTypes
                    update_json(Levellist[11],'InLoop',BusinessSegment,l1,l5,l12)
                for l13 in range(Valuelist[12]):   #SectionRatingFactorTypes
                    update_json(Levellist[12],'InLoop',BusinessSegment,l1,l5,l13)
                for l14 in range(Valuelist[13]):   #Regions
                    update_json(Levellist[13],'InLoop',BusinessSegment,l1,l5,l14)
                    for l15 in range(Valuelist[14]):   #RegionRatingFactorTypes
                        update_json(Levellist[14],'InLoop',BusinessSegment,l1,l5,l14,l15)
                for l16 in range(Valuelist[15]):   #Products
                    update_json(Levellist[15],'InLoop',BusinessSegment,l1,l5,l16)
                    for l17 in range(Valuelist[16]):   #ProductRatingFactorTypes
                        update_json(Levellist[16],'InLoop',BusinessSegment,l1,l5,l16,l17)
        for l18 in range(Valuelist[17]):   #ILFDistributions
            update_json(Levellist[17],'InLoop',BusinessSegment,l18)
        for l19 in range(Valuelist[18]):   #ProductRiskScoreMappings
            update_json(Levellist[18],'InLoop',BusinessSegment,l19)
        for l20 in range(Valuelist[19]):   #FoodFactors
            update_json(Levellist[19],'InLoop',BusinessSegment,l20)
    case 'PV':
        for l1 in range(Valuelist[0]): #Contracts
            update_json(Levellist[0],'InLoop',BusinessSegment,l1)
            for l2 in range(Valuelist[1]): #ContractParties
                update_json(Levellist[1],'InLoop',BusinessSegment,l1,l2)
            for l3 in range(Valuelist[2]): #Sections
                update_json(Levellist[2],'InLoop',BusinessSegment,l1,l3)
                for l4 in range(Valuelist[3]): #SectionParties
                    update_json(Levellist[3],'InLoop',BusinessSegment,l1,l3,l4)
                    for l5 in range(Valuelist[4]): #PartyFinancialTypes
                        update_json(Levellist[4],'InLoop',BusinessSegment,l1,l3,l4,l5)
                for l6 in range(Valuelist[5]): #Coverages
                    update_json(Levellist[5],'InLoop',BusinessSegment,l1,l3,l6)
                    for l7 in range(Valuelist[6]): #CoverageRatingFactorTypes
                        update_json(Levellist[6],'InLoop',BusinessSegment,l1,l3,l6,l7)
                    for l8 in range(Valuelist[7]): #CoverageLimitExcessDeductible
                        update_json(Levellist[7],'InLoop',BusinessSegment,l1,l3,l6,l8)
                    for l9 in range(Valuelist[8]): #CoverageExposure
                        update_json(Levellist[8],'InLoop',BusinessSegment,l1,l3,l6,l9)
                        for l10 in range(Valuelist[9]): #CoverageExposureRatingFactorTypes
                            update_json(Levellist[9],'InLoop',BusinessSegment,l1,l3,l6,l10)
                for l11 in range(Valuelist[10]): #SectionRatingFactorTypes
                    update_json(Levellist[10],'InLoop',BusinessSegment,l1,l3,l11)
                for l12 in range(Valuelist[11]): #SectionFinancialTypes
                    update_json(Levellist[11],'InLoop',BusinessSegment,l1,l3,l12)
                for l13 in range(Valuelist[12]): #Schedule
                    update_json(Levellist[12],'InLoop',BusinessSegment,l1,l3,l13)
                    for l14 in range(Valuelist[13]): #ScheduleCoverages
                        update_json(Levellist[13],'InLoop',BusinessSegment,l1,l3,l13,l14)
                        for l15 in range(Valuelist[14]): #CoverageRatingFactorTypes
                            update_json(Levellist[14],'InLoop',BusinessSegment,l1,l3,l13,l14,l15)
                    for l16 in range(Valuelist[15]): #ScheduleCoverages
                        update_json(Levellist[15],'InLoop',BusinessSegment,l1,l3,l13,l16)
            for l17 in range(Valuelist[16]): #PolicyTerm
                update_json(Levellist[16],'InLoop',BusinessSegment,l1,l17)

    case 'MH':
        for l1 in range(Valuelist[0]): #Contracts
            update_json(Levellist[0],'InLoop',BusinessSegment,l1)
            for l2 in range(Valuelist[1]): #ContractParties
                update_json(Levellist[1],'InLoop',BusinessSegment,l1,l2)
            for l3 in range(Valuelist[2]): #ContractRatingFactorTypes
                update_json(Levellist[2],'InLoop',BusinessSegment,l1,l3)
            for l4 in range(Valuelist[3]): #ContractFinancialTypes
                update_json(Levellist[3],'InLoop',BusinessSegment,l1,l4)
            for l5 in range(Valuelist[4]): #Sections
                update_json(Levellist[4],'InLoop',BusinessSegment,l1,l5)
                for l6 in range(Valuelist[5]): #SectionParties
                    update_json(Levellist[5],'InLoop',BusinessSegment,l1,l5,l6)
                    for l7 in range(Valuelist[6]): #PartyFinancialTypes
                        update_json(Levellist[6],'InLoop',BusinessSegment,l1,l5,l6,l7)
                for l8 in range(Valuelist[7]): #Coverages
                    update_json(Levellist[7],'InLoop',BusinessSegment,l1,l5,l8)
                    for l9 in range(Valuelist[8]): #CoverageRatingFactorTypes
                        update_json(Levellist[8],'InLoop',BusinessSegment,l1,l5,l8,l9)
                    for l10 in range(Valuelist[9]): #CoverageFinancialTypes
                        update_json(Levellist[9],'InLoop',BusinessSegment,l1,l5,l8,l10)
                for l11 in range(Valuelist[10]): #SectionLimitExcessDeductibles
                    update_json(Levellist[10],'InLoop',BusinessSegment,l1,l5,l11)
                for l12 in range(Valuelist[11]): #SectionRatingFactorTypes
                    update_json(Levellist[11],'InLoop',BusinessSegment,l1,l5,l12)
                for l13 in range(Valuelist[12]): #SectionFinancialTypes
                    update_json(Levellist[12],'InLoop',BusinessSegment,l1,l5,l13)
                for l13 in range(Valuelist[13]): #Schedules
                    update_json(Levellist[13],'InLoop',BusinessSegment,l1,l5,l13)
                    for l14 in range(Valuelist[14]): #ScheduleRatingFactorTypes
                        update_json(Levellist[14],'InLoop',BusinessSegment,l1,l5,l13,l14)
                    for l15 in range(Valuelist[15]): #ScheduleCoverages
                        update_json(Levellist[15],'InLoop',BusinessSegment,l1,l5,l13,l15)
                        for l16 in range(Valuelist[16]): #CoverageLimitExcessDeductibles
                            update_json(Levellist[16],'InLoop',BusinessSegment,l1,l5,l13,l15,l16)
                        for l17 in range(Valuelist[17]): #CoverageFinancialTypes
                            update_json(Levellist[17],'InLoop',BusinessSegment,l1,l5,l13,l15,l17)
            for l17 in range(Valuelist[19]): #v_GLM_HM_Freq_VesselTypeGroup
                update_json(Levellist[19],'InLoop',BusinessSegment,l1,l17)
            for l18 in range(Valuelist[20]): #v_GLM_HM_Sev_Beta_VesselTypeGroup
                update_json(Levellist[20],'InLoop',BusinessSegment,l1,l18)
            for l19 in range(Valuelist[21]): #v_GLM_TL_Freq_VesselTypeGroup
                update_json(Levellist[21],'InLoop',BusinessSegment,l1,l19)




out_file = open(r"C:\Python Workspace\NewImplementation\HxInput_test.json","w")

json.dump(HxInputData,out_file,indent=6)

out_file.close()
